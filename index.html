<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard History Piutang</title>

    <!-- CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
      body {
        background: #f7f9fc;
      }
      .card-stats {
        border-radius: 10px;
      }
      .table-responsive {
        overflow: auto;
      }
      .nowrap {
        white-space: nowrap;
      }
      .modal-lg {
        max-width: 980px;
      }
      .small-muted {
        font-size: 0.85rem;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">
          <i class="bi bi-receipt me-2 text-primary"></i>Dashboard History
          Piutang
        </h3>
        <div>
          <button id="refreshBtn" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>

      <!-- summary cards -->
      <div class="row g-2 mb-3" id="summaryRow">
        <div class="col-md-4">
          <div class="card card-stats shadow-sm p-3">
            <div class="small text-muted">Total Nilai Invoice</div>
            <div id="totalInvoice" class="h5 fw-bold">-</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-stats shadow-sm p-3">
            <div class="small text-muted">Total Jumlah Pembayaran</div>
            <div id="totalPaid" class="h5 fw-bold">-</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-stats shadow-sm p-3">
            <div class="small text-muted">Total Sisa Piutang</div>
            <div id="totalOutstanding" class="h5 fw-bold text-danger">-</div>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="table-responsive">
            <table
              id="historyTable"
              class="table table-striped table-hover table-bordered align-middle"
              style="width: 100%"
            >
              <thead class="table-light text-center">
                <tr>
                  <th>No Invoice</th>
                  <th>Tanggal Invoice</th>
                  <th>Nilai Invoice</th>
                  <th>J.Tempo</th>
                  <th>Cara Pembayaran</th>
                  <th>Bank</th>
                  <th>Tanggal Kliring</th>
                  <th>Jumlah Pembayaran</th>
                  <th>Sisa Piutang</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detail Invoice</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="modalBodyContent"></div>
        </div>
      </div>
    </div>

    <script>
      const CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKiGqtM_f_HXaKuGVF8zk_smxSwC1IVcR-jpCaRi4GWyOy8C_HqqGYyDJ8Tzq9TNKFnBpcOI_CK4kP/pub?gid=1009399002&single=true&output=csv";
      let parsedData = [];

      $(document).ready(function () {
        loadData();
        $("#refreshBtn").on("click", loadData);

        $("#historyTable").on("click", ".btn-detail", function () {
          const idx = $(this).data("idx");
          showModal(parsedData[idx]);
        });
      });

      function loadData() {
        Papa.parse(CSV_URL, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            parsedData = normalize(results.data);
            renderSummary(parsedData);
            renderTable(parsedData);
          },
          error: function (err) {
            console.error("CSV load error", err);
            alert("Gagal memuat data CSV. Cek link atau koneksi.");
          },
        });
      }

      function normalize(rows) {
        // Expected headers (from your spreadsheet):
        // A: No Invoice, B: Tanggal Invoice, C: Nilai Invoice, D: J.Tempo,
        // E: Cara Pembayaran, F: Bank, G: Tanggal Kliring, H: Jumlah Pembayaran,
        // I: Sisa Piutang, J: Kode Langganan, K: Nama Langganan, L: Salesman
        return rows
          .map((r) => {
            const fmt = (v) =>
              v === undefined || v === null ? "" : String(v).trim();

            const num = (v) => {
              // bersihkan karakter yang bukan angka, titik, koma, minus
              let s = String(v || "")
                .replace(/[^\d\-\.,]/g, "")
                .trim();
              if (s === "") return 0;

              // hapus titik ribuan, ubah koma desimal jadi titik
              s = s.replace(/\./g, "");
              s = s.replace(/,/g, ".");
              const parsed = parseFloat(s);
              return isNaN(parsed) ? 0 : parsed;
            };

            return {
              no_invoice: fmt(
                r["No Invoice"] || r["NoInvoice"] || r["no invoice"] || r["A"]
              ),
              tanggal_invoice: fmt(
                r["Tanggal Invoice"] || r["TanggalInvoice"] || r["B"]
              ),
              nilai_invoice: num(
                r["Nilai Invoice"] || r["NilaiInvoice"] || r["C"]
              ),
              jtempo: fmt(
                r["J.Tempo"] || r["J Tempo"] || r["JTempo"] || r["D"]
              ),
              cara_pembayaran: fmt(
                r["Cara Pembayaran"] || r["CaraPembayaran"] || r["E"]
              ),
              bank: fmt(r["Bank"] || r["F"]),
              tanggal_kliring: fmt(
                r["Tanggal Kliring"] || r["TanggalKliring"] || r["G"]
              ),
              jumlah_pembayaran: num(
                r["Jumlah Pembayaran"] || r["JumlahPembayaran"] || r["H"]
              ),
              sisa_piutang: num(
                r["Sisa Piutang"] || r["SisaPiutang"] || r["I"]
              ),
              kode_langganan: fmt(
                r["Kode Langganan"] || r["KodeLangganan"] || r["J"]
              ),
              nama_langganan: fmt(
                r["Nama Langganan"] || r["NamaLangganan"] || r["K"]
              ),
              salesman: fmt(r["Salesman"] || r["Sales Man"] || r["L"]),
            };
          })
          .filter(
            (r) =>
              r.no_invoice ||
              r.tanggal_invoice ||
              r.nilai_invoice ||
              r.jumlah_pembayaran ||
              r.sisa_piutang
          );
      }

      function formatCurrency(n) {
        try {
          return new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            maximumFractionDigits: 0,
          }).format(n);
        } catch (e) {
          return n;
        }
      }

      function renderSummary(data) {
        const totalInvoice = data.reduce(
          (s, x) => s + (Number(x.nilai_invoice) || 0),
          0
        );
        const totalPaid = data.reduce(
          (s, x) => s + (Number(x.jumlah_pembayaran) || 0),
          0
        );
        const totalOutstanding = data.reduce(
          (s, x) => s + (Number(x.sisa_piutang) || 0),
          0
        );

        $("#totalInvoice").text(formatCurrency(totalInvoice));
        $("#totalPaid").text(formatCurrency(totalPaid));
        $("#totalOutstanding").text(formatCurrency(totalOutstanding));
      }

      function renderTable(data) {
        if ($.fn.DataTable.isDataTable("#historyTable")) {
          $("#historyTable").DataTable().destroy();
        }
        $("#tableBody").empty();

        data.forEach((row, idx) => {
          const tr = $("<tr>");
          tr.append(
            $("<td>")
              .addClass("nowrap")
              .text(row.no_invoice || "-")
          );
          tr.append($("<td>").text(row.tanggal_invoice || "-"));
          tr.append(
            $("<td>")
              .addClass("text-end")
              .text(formatCurrency(row.nilai_invoice))
          );
          tr.append($("<td>").text(row.jtempo || "-"));
          tr.append($("<td>").text(row.cara_pembayaran || "-"));
          tr.append($("<td>").text(row.bank || "-"));
          tr.append($("<td>").text(row.tanggal_kliring || "-"));
          tr.append(
            $("<td>")
              .addClass("text-end")
              .text(formatCurrency(row.jumlah_pembayaran))
          );
          tr.append(
            $("<td>")
              .addClass("text-end")
              .text(formatCurrency(row.sisa_piutang))
          );
          tr.append(
            $("<td>")
              .addClass("text-center")
              .html(
                `<button class="btn btn-sm btn-outline-primary btn-detail" data-idx="${idx}" title="Lihat detail"><i class="bi bi-eye"></i></button>`
              )
          );
          $("#tableBody").append(tr);
        });

        $("#historyTable").DataTable({
          responsive: true,
          scrollX: true,
          pageLength: 10,
          lengthMenu: [5, 10, 25, 50, 100],
          order: [[1, "desc"]],
          columnDefs: [
            { targets: [2, 7, 8], className: "text-end" },
            { targets: [0, 1, 3, 4, 5, 6, 9], className: "text-center" },
          ],
        });
      }

      function showModal(row) {
        if (!row) return;
        const html = `
      <div class="row g-2">
        <div class="col-md-6">
          <div class="card mb-2"><div class="card-header">No Invoice</div><div class="card-body">${
            row.no_invoice
          }</div></div>
          <div class="card mb-2"><div class="card-header">Tanggal Invoice</div><div class="card-body">${
            row.tanggal_invoice
          }</div></div>
          <div class="card mb-2"><div class="card-header">Nilai Invoice</div><div class="card-body text-end fw-bold">${formatCurrency(
            row.nilai_invoice
          )}</div></div>
        </div>
        <div class="col-md-6">
          <div class="card mb-2"><div class="card-header">Cara Pembayaran</div><div class="card-body">${
            row.cara_pembayaran
          }</div></div>
          <div class="card mb-2"><div class="card-header">Bank</div><div class="card-body">${
            row.bank
          }</div></div>
          <div class="card mb-2"><div class="card-header">J.Tempo</div><div class="card-body">${
            row.jtempo
          }</div></div>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-md-4"><div class="card"><div class="card-header">Tanggal Kliring</div><div class="card-body">${
          row.tanggal_kliring
        }</div></div></div>
        <div class="col-md-4"><div class="card"><div class="card-header">Jumlah Pembayaran</div><div class="card-body text-end">${formatCurrency(
          row.jumlah_pembayaran
        )}</div></div></div>
        <div class="col-md-4"><div class="card"><div class="card-header">Sisa Piutang</div><div class="card-body text-end text-danger fw-bold">${formatCurrency(
          row.sisa_piutang
        )}</div></div></div>
      </div>

      <hr/>

      <div class="row g-2 mt-2">
        <div class="col-md-4"><div class="card"><div class="card-header">Kode Langganan</div><div class="card-body">${
          row.kode_langganan || "-"
        }</div></div></div>
        <div class="col-md-4"><div class="card"><div class="card-header">Nama Langganan</div><div class="card-body">${
          row.nama_langganan || "-"
        }</div></div></div>
        <div class="col-md-4"><div class="card"><div class="card-header">Salesman</div><div class="card-body">${
          row.salesman || "-"
        }</div></div></div>
      </div>
    `;
        $("#modalBodyContent").html(html);
        var modal = new bootstrap.Modal(document.getElementById("detailModal"));
        modal.show();
      }
    </script>
  </body>
</html>
